# .github/workflows/build-release.yml

name: ğŸ“¦ Build and Release

# è§¦å‘æ¡ä»¶ï¼šå½“ä¸€ä¸ªä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ (ä¾‹å¦‚ v1.0, v1.2.3) è¢«æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'

# ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†åç§°
env:
  # !!! è¯·å°†è¿™é‡Œçš„ 'éŸ³é¢‘ç®¡ç†å™¨2.spec' ä¿®æ”¹ä¸ºæ‚¨å®é™…çš„ .spec æ–‡ä»¶å !!!
  SPEC_NAME: 'audiohub.spec'
  # !!! è¯·å°†è¿™é‡Œçš„ 'AudioHub' ä¿®æ”¹ä¸ºæ‚¨æ‰“åŒ…åå¸Œæœ›çš„ç¨‹åºä¸»æ–‡ä»¶å !!!
  APP_NAME: 'AudioHub'


jobs:
  build_and_release:
    # ä½¿ç”¨ç­–ç•¥çŸ©é˜µï¼Œä¸ºä¸‰ä¸ªä¸»æµæ“ä½œç³»ç»Ÿåˆ†åˆ«åˆ›å»ºä¸€ä¸ªæ„å»ºä»»åŠ¡
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    # æŒ‡å®šä»»åŠ¡è¿è¡Œçš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ${{ matrix.os }}

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      # æ‹‰å–ä½ çš„ä»“åº“ä»£ç åˆ°è™šæ‹Ÿæœºä¸­
      - name:  checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Python ç¯å¢ƒ
      # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ç³»ç»Ÿå’Œ Python ä¾èµ–
      # è¿™ä¸€æ­¥æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿæ‰§è¡Œä¸åŒçš„å‘½ä»¤æ¥å®‰è£… FFmpeg å’Œ UPX
      - name: Install dependencies
        run: |
          # å®‰è£… Python ä¾èµ–åº“
          pip install -r requirements.txt
          pip install pyinstaller

          # æ ¹æ®æ“ä½œç³»ç»Ÿå®‰è£…ç³»ç»Ÿçº§ä¾èµ– (FFmpeg & UPX)
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y ffmpeg upx-ucl
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install ffmpeg upx
          elif [ "$RUNNER_OS" == "Windows" ]; then
            # åœ¨ Windows runner ä¸Šï¼Œä½¿ç”¨ Chocolatey åŒ…ç®¡ç†å™¨
            choco install ffmpeg upx
          fi
        shell: bash

      # ç¬¬å››æ­¥ï¼šä½¿ç”¨ PyInstaller å’Œ UPX è¿›è¡Œæ‰“åŒ…
      # --noconfirm: è¦†ç›–æ—§çš„æ„å»ºæ–‡ä»¶ï¼Œä¸éœ€ç¡®è®¤
      # --upx: å¯ç”¨ UPX å‹ç¼©
      - name: Build with PyInstaller and UPX
        run: pyinstaller --noconfirm --upx ${{ env.SPEC_NAME }}

      # ç¬¬äº”æ­¥ï¼šæ‰“åŒ…æ„å»ºç»“æœä»¥ä¾¿ä¸Šä¼ 
      # å°† dist ç›®å½•ä¸‹çš„ç¨‹åºæ‰“åŒ…æˆ .zip æˆ– .tar.gz
      - name: Package the artifact
        id: package
        run: |
          # å®šä¹‰è¾“å‡ºç›®å½•å’Œæœ€ç»ˆæ–‡ä»¶å
          OUTPUT_DIR="dist/${{ env.APP_NAME }}"
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Windows: è¾“å‡º .zip æ ¼å¼
            ARTIFACT_NAME="${{ env.APP_NAME }}-Windows.zip"
            7z a -tzip $ARTIFACT_NAME "./${OUTPUT_DIR}/*"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            # macOS: è¾“å‡º .zip æ ¼å¼, .app æ–‡ä»¶å¤¹éœ€è¦ç‰¹æ®Šå¤„ç†
            ARTIFACT_NAME="${{ env.APP_NAME }}-macOS.zip"
            # ä½¿ç”¨ ditto æ¥æ­£ç¡®æ‰“åŒ… .app
            ditto -c -k --sequesterRsrc --keepParent "${OUTPUT_DIR}.app" $ARTIFACT_NAME
          else
            # Linux: è¾“å‡º .tar.gz æ ¼å¼
            ARTIFACT_NAME="${{ env.APP_NAME }}-Linux.tar.gz"
            tar -czvf $ARTIFACT_NAME -C $OUTPUT_DIR .
          fi
          
          # å°†æœ€ç»ˆçš„æ–‡ä»¶åè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
        shell: bash

      # ç¬¬å…­æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Release
      # ä½¿ç”¨ç¤¾åŒºç»´æŠ¤çš„ svenstaro/upload-release-action åŠ¨ä½œ
      - name: Upload Release Asset
        uses: svenstaro/upload-release-action@v2
        with:
          # GITHUB_TOKEN æ˜¯ GitHub è‡ªåŠ¨æä¾›çš„ï¼Œç”¨äºæˆæƒ
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          # ä»ä¸Šä¸€æ­¥è·å–è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          file: ${{ steps.package.outputs.artifact_name }}
          # åœ¨ Release é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ–‡ä»¶å
          asset_name: ${{ steps.package.outputs.artifact_name }}
          # ä¸Šä¼ åˆ°å½“å‰è§¦å‘å·¥ä½œæµçš„æ ‡ç­¾æ‰€å¯¹åº”çš„ Release
          tag: ${{ github.ref }}
          # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™è¦†ç›–
          overwrite: true
