# .github/workflows/build-release.yml

name: ðŸ“¦ Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  SPEC_NAME: 'audiohub.spec'
  APP_NAME: 'audiohub'

jobs:
  build_and_release:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    permissions:
      contents: write
      
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. ä¸º pip æ·»åŠ ç¼“å­˜ï¼ŒåŠ é€ŸåŽç»­æž„å»º
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. å®‰è£…ç³»ç»Ÿå’Œ Python ä¾èµ–
      - name: Install dependencies
        run: |
          # --- æ­¥éª¤ 1: å…ˆå®‰è£…ç³»ç»Ÿçº§ä¾èµ– ---
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y portaudio19-dev libasound2-dev ffmpeg upx-ucl
          elif [ "$RUNNER_OS" == "macOS" ]; then
            # â†“â†“â†“ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â†“â†“â†“
            brew install portaudio ffmpeg upx
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install ffmpeg upx
          fi

          # --- æ­¥éª¤ 2: å†å®‰è£… Python ä¾èµ– ---
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
        shell: bash

      # 5. ä½¿ç”¨ PyInstaller è¿›è¡Œæ‰“åŒ…
      - name: Build with PyInstaller
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Windows é»˜è®¤è¡Œä¸ºæ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹
            pyinstaller --noconfirm ${{ env.SPEC_NAME }}
          else
            # å¯¹äºŽ Linux å’Œ macOSï¼Œä½¿ç”¨ --upx-dir å¼ºåˆ¶å¯ç”¨ UPX
            # /usr/bin/ æ˜¯ upx-ucl å’Œ brew install upx çš„æ ‡å‡†å®‰è£…è·¯å¾„
            pyinstaller --noconfirm --upx-dir /usr/bin/ ${{ env.SPEC_NAME }}
          fi
        shell: bash

      # 6. æ‰“åŒ…æž„å»ºç»“æžœ
      - name: Package the artifact
        id: package
        run: |
          OUTPUT_DIR="dist/${{ env.APP_NAME }}"
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            ARTIFACT_NAME="${{ env.APP_NAME }}-Windows.zip"

            7z a -tzip $ARTIFACT_NAME "./dist/${{ env.APP_NAME }}.exe"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            ARTIFACT_NAME="${{ env.APP_NAME }}-macOS.zip"

            ditto -c -k --sequesterRsrc --keepParent "${OUTPUT_DIR}.app" $ARTIFACT_NAME
          else
            ARTIFACT_NAME="${{ env.APP_NAME }}-Linux.tar.gz"

            tar -czvf $ARTIFACT_NAME -C ./dist ${{ env.APP_NAME }}
          fi
          
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
        shell: bash

      # 7. ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° Release
      - name: Upload Release Asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.package.outputs.artifact_name }}
          asset_name: ${{ steps.package.outputs.artifact_name }}
          tag: ${{ github.ref }}
          overwrite: true
